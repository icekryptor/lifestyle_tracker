<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lifestyle Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'sans-serif']
          },
          colors: {
            navy: {
              50: '#e8edf5',
              100: '#c5d1e3',
              200: '#a0b3d1',
              900: '#0f1729',
              950: '#0a1019'
            },
            slate: {
              700: '#2a3647',
              800: '#1e2a3a',
              850: '#1a2332',
              900: '#0f1729'
            },
            indigo: {
              400: '#a5b4fc',
              500: '#818cf8',
              600: '#6366f1',
              700: '#4f46e5'
            },
            dark: {
              border: '#2d3d54',
              text: '#e1e7f0',
              muted: '#8b95a8'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-navy-900 text-dark-text min-h-screen font-sans">
  <!-- Mobile/Desktop Container -->
  <div class="w-full">
    <!-- Header -->
    <header class="bg-slate-800 border-b border-dark-border sticky top-0 z-10 backdrop-blur-sm bg-opacity-95">
      <div class="max-w-[1920px] mx-auto px-4 lg:px-8 py-4">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-medium tracking-tight">Lifestyle Tracker</h1>
            <div class="flex gap-4 mt-1">
              <p class="text-sm text-dark-muted font-light" id="todayDate"></p>
              <p class="text-xs text-dark-muted/60" id="userEmail"></p>
            </div>
          </div>
          <div class="flex gap-2">
            <a href="profile.html" class="w-10 h-10 rounded-lg border border-dark-border hover:border-indigo-500 hover:text-indigo-400 transition-colors flex items-center justify-center" title="Profile">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
            </a>
            <button id="logoutBtn" class="text-sm px-4 py-2 rounded-lg border border-dark-border hover:border-red-400 hover:text-red-400 transition-colors">
              Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Dashboard Grid -->
    <main class="max-w-[1920px] mx-auto px-4 lg:px-8 py-6">
      <!-- 12-Column Grid Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-6">

        <!-- Left Column: Daily Goal Progress (4 cols) -->
        <section class="lg:col-span-4 bg-slate-800 rounded-xl border border-dark-border p-6" id="dailyGoalSection">
      <h3 class="text-xs font-medium uppercase tracking-wider text-dark-muted mb-4">Today's Calorie Goal</h3>
      
      <div class="flex items-center justify-between">
        <!-- Circular Progress -->
        <div class="relative flex items-center justify-center">
          <svg class="transform -rotate-90" width="120" height="120">
            <!-- Background circle -->
            <circle
              cx="60"
              cy="60"
              r="52"
              stroke="#2d3d54"
              stroke-width="8"
              fill="none"
            />
            <!-- Progress circle -->
            <circle
              id="progressCircle"
              cx="60"
              cy="60"
              r="52"
              stroke="#818cf8"
              stroke-width="8"
              fill="none"
              stroke-dasharray="326.73"
              stroke-dashoffset="326.73"
              stroke-linecap="round"
              style="transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease"
            />
          </svg>
          <!-- Center text -->
          <div class="absolute inset-0 flex flex-col items-center justify-center">
            <span class="text-2xl font-semibold" id="goalPercentage">0%</span>
            <span class="text-xs text-dark-muted">of goal</span>
          </div>
        </div>

        <!-- Goal Details -->
        <div class="flex-1 ml-6 space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-dark-muted">Consumed:</span>
            <span class="font-medium" id="caloriesConsumed">0 cal</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-dark-muted">Goal:</span>
            <span class="font-medium" id="caloriesGoal">-- cal</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-dark-muted">Remaining:</span>
            <span class="font-medium" id="caloriesRemaining">-- cal</span>
          </div>
          <div class="mt-3 pt-3 border-t border-dark-border">
            <div class="text-xs text-dark-muted/70" id="goalStrategyText">Set your goals in Profile</div>
          </div>
        </div>
      </div>
        </section>

        <!-- Middle Column: Today's Tasks (5 cols) -->
        <section class="lg:col-span-5 space-y-4">
          <div class="bg-slate-800 rounded-xl border border-dark-border p-6">
            <h3 class="text-xs font-medium uppercase tracking-wider text-dark-muted mb-4">Today's Tasks</h3>
            <div class="grid gap-3" id="todayTasks">
        <!-- Sleep task -->
        <a href="sleep.html" id="sleepTask" class="block bg-slate-800 border-2 border-dark-border rounded-xl p-4 hover:border-lavender transition-colors group">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-lavender/10 flex items-center justify-center text-indigo-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-sm" id="sleepTaskTitle">Log your sleep</div>
                <div class="text-xs text-dark-muted" id="sleepTaskDesc">Track last night's rest</div>
              </div>
            </div>
            <svg class="w-5 h-5 text-dark-muted group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </a>

        <!-- Nutrition task -->
        <a href="nutrition.html" id="nutritionTask" class="block bg-slate-800 border-2 border-dark-border rounded-xl p-4 hover:border-terracotta transition-colors group">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-indigo-600/10 flex items-center justify-center text-indigo-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-sm" id="nutritionTaskTitle">Log your meals</div>
                <div class="text-xs text-dark-muted" id="nutritionTaskDesc">Track what you eat today</div>
              </div>
            </div>
            <svg class="w-5 h-5 text-dark-muted group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </a>

        <!-- Activity task -->
        <a href="activity.html" id="activityTask" class="block bg-slate-800 border-2 border-dark-border rounded-xl p-4 hover:border-teal transition-colors group">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-teal/10 flex items-center justify-center text-indigo-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-sm" id="activityTaskTitle">Log your activity</div>
                <div class="text-xs text-dark-muted" id="activityTaskDesc">Track your exercise</div>
              </div>
            </div>
            <svg class="w-5 h-5 text-dark-muted group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </a>

        <!-- Training task -->
        <a href="training.html" id="trainingTask" class="block bg-slate-800 border-2 border-dark-border rounded-xl p-4 hover:border-indigo-500 transition-colors group">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-indigo-600/10 flex items-center justify-center text-indigo-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-sm" id="trainingTaskTitle">Training Diary</div>
                <div class="text-xs text-dark-muted" id="trainingTaskDesc">Log your workouts</div>
              </div>
            </div>
            <svg class="w-5 h-5 text-dark-muted group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
            </a>
            </div>
          </div>
        </section>

        <!-- Right Column: Quick Summary (3 cols) -->
        <section class="lg:col-span-3 space-y-4">
          <!-- Today's Summary Card -->
          <div class="bg-gradient-to-br from-indigo-500/10 to-indigo-600/10 rounded-xl border border-dark-border p-6">
            <h3 class="text-xs font-medium uppercase tracking-wider text-dark-muted mb-4">Today's Summary</h3>
            <div class="space-y-3">
              <div>
                <div class="text-2xl font-semibold" id="summaryCalories">0</div>
                <div class="text-xs text-dark-muted">Calories consumed</div>
              </div>
              <div>
                <div class="text-2xl font-semibold" id="summaryWorkouts">0</div>
                <div class="text-xs text-dark-muted">Workouts completed</div>
              </div>
              <div>
                <div class="text-2xl font-semibold" id="summarySleep">--</div>
                <div class="text-xs text-dark-muted">Hours of sleep</div>
              </div>
            </div>
          </div>

          <!-- Quick Links -->
          <div class="bg-slate-800 rounded-xl border border-dark-border p-6">
            <h3 class="text-xs font-medium uppercase tracking-wider text-dark-muted mb-4">Quick Access</h3>
            <div class="space-y-2">
              <a href="nutrition.html" class="block py-2 px-3 rounded-lg hover:bg-indigo-600/5 hover:text-indigo-400 transition-colors text-sm">
                üçΩÔ∏è Food Library
              </a>
              <a href="exercise-library.html" class="block py-2 px-3 rounded-lg hover:bg-indigo-600/5 hover:text-indigo-400 transition-colors text-sm">
                üí™ Exercise Library
              </a>
              <a href="profile.html" class="block py-2 px-3 rounded-lg hover:bg-lavender/5 hover:text-indigo-400 transition-colors text-sm">
                üë§ My Profile
              </a>
            </div>
          </div>
        </section>

        <!-- Row 2: Trends with Date Range Selector -->
        <section class="lg:col-span-12">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xs font-medium uppercase tracking-wider text-dark-muted">Trends</h3>
            <div class="flex gap-2 items-center">
              <input type="date" id="dateRangeStart" class="text-xs border border-dark-border rounded-lg px-2 py-1 focus:outline-none focus:border-indigo-500" />
              <span class="text-xs text-dark-muted">to</span>
              <input type="date" id="dateRangeEnd" class="text-xs border border-dark-border rounded-lg px-2 py-1 focus:outline-none focus:border-indigo-500" />
              <button id="applyDateRange" class="text-xs px-3 py-1 bg-indigo-600 text-white rounded-lg hover:opacity-90 transition-opacity">
                Apply
              </button>
              <button id="reset7Days" class="text-xs px-3 py-1 border border-dark-border rounded-lg hover:bg-slate-700/30 transition-colors">
                Last 7 Days
              </button>
            </div>
          </div>
        </section>

        <!-- Sleep quality trend (3 cols) -->
        <div class="lg:col-span-3 bg-slate-800 border border-dark-border rounded-xl p-5">
          <div class="flex justify-between items-baseline mb-3">
            <span class="text-sm font-medium">Sleep Quality</span>
            <span class="text-xs text-dark-muted" id="dashSleepAvg">‚Äî</span>
          </div>
          <div class="relative h-32 pt-4" id="dashSleepChart"></div>
        </div>

        <!-- Nutrition trend (3 cols) -->
        <div class="lg:col-span-3 bg-slate-800 border border-dark-border rounded-xl p-5">
          <div class="flex justify-between items-baseline mb-3">
            <span class="text-sm font-medium">Nutrition</span>
            <span class="text-xs text-dark-muted" id="dashNutritionAvg">‚Äî</span>
          </div>
          <div class="relative h-32 pt-4" id="dashNutritionChart"></div>
        </div>

        <!-- Activity trend (3 cols) -->
        <div class="lg:col-span-3 bg-slate-800 border border-dark-border rounded-xl p-5">
          <div class="flex justify-between items-baseline mb-3">
            <span class="text-sm font-medium">Activity</span>
            <span class="text-xs text-dark-muted" id="dashActivityAvg">‚Äî</span>
          </div>
          <div class="relative h-32 pt-4" id="dashActivityChart"></div>
        </div>

        <!-- Training trend (3 cols) -->
        <div class="lg:col-span-3 bg-slate-800 border border-dark-border rounded-xl p-5">
          <div class="flex justify-between items-baseline mb-3">
            <span class="text-sm font-medium">Training Calories</span>
            <span class="text-xs text-dark-muted" id="dashTrainingAvg">‚Äî</span>
          </div>
          <div class="relative h-32 pt-4" id="dashTrainingChart"></div>
        </div>

      </div>
    </main>
  </div>

  <!-- Load Supabase + DB first -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="db.js"></script>
  <script src="app.js"></script>
  <script src="training-logic.js"></script>
  <script src="seed-data.js"></script>
  <script>
    // Update today's date
    document.getElementById('todayDate').textContent = formatDate(todayKey());

    // Update today's tasks based on completion status
    async function updateTodayTasks() {
      // Load all data into cache first
      await getData('sleep');
      await getData('nutrition');
      await getData('activity');

      const sleepData = getTodayData('sleep');
      const nutritionData = getTodayData('nutrition');
      const activityData = getTodayData('activity');

      // Sleep task
      const sleepTask = document.getElementById('sleepTask');
      const sleepTitle = document.getElementById('sleepTaskTitle');
      const sleepDesc = document.getElementById('sleepTaskDesc');
      
      if (sleepData && sleepData.bedtime) {
        sleepTask.classList.remove('border-2', 'border-dark-border');
        sleepTask.classList.add('border', 'border-indigo-500/50', 'bg-indigo-600/10');
        sleepTitle.innerHTML = '‚úì Sleep logged';
        sleepDesc.textContent = `${formatDuration(sleepData.durationMins)} ‚Ä¢ ${sleepData.rating}`;
      }

      // Nutrition task
      const nutritionTask = document.getElementById('nutritionTask');
      const nutritionTitle = document.getElementById('nutritionTaskTitle');
      const nutritionDesc = document.getElementById('nutritionTaskDesc');
      
      if (nutritionData && nutritionData.meals && Object.keys(nutritionData.meals).length > 0) {
        const meals = nutritionData.meals;
        const mealCount = Object.keys(meals).length;
        
        let totalCals = 0;
        Object.values(meals).forEach(meal => {
          // Handle both array (new) and object (old) formats
          if (Array.isArray(meal)) {
            totalCals += meal.reduce((s, dish) => s + (dish.calories || 0), 0);
          } else {
            totalCals += meal.calories || 0;
          }
        });
        
        nutritionTask.classList.remove('border-2', 'border-dark-border');
        nutritionTask.classList.add('border', 'border-indigo-500/50', 'bg-indigo-600/10');
        nutritionTitle.innerHTML = '‚úì Meals logged';
        nutritionDesc.textContent = `${mealCount} meal(s)${totalCals ? ' ‚Ä¢ ' + totalCals + ' cal' : ''}`;
      }

      // Activity task
      const activityTask = document.getElementById('activityTask');
      const activityTitle = document.getElementById('activityTaskTitle');
      const activityDesc = document.getElementById('activityTaskDesc');
      
      if (activityData && (activityData.steps > 0 || (activityData.gymSessions && activityData.gymSessions.length > 0))) {
        const steps = activityData.steps || 0;
        const gymMins = (activityData.gymSessions || []).reduce((s, g) => s + (g.minutes || 0), 0);
        activityTask.classList.remove('border-2', 'border-dark-border');
        activityTask.classList.add('border', 'border-indigo-500/50', 'bg-indigo-600/10');
        activityTitle.innerHTML = '‚úì Activity logged';
        activityDesc.textContent = `${steps.toLocaleString()} steps${gymMins ? ' ‚Ä¢ ' + gymMins + ' min gym' : ''}`;
      }

      // Training task
      const trainingTask = document.getElementById('trainingTask');
      const trainingTitle = document.getElementById('trainingTaskTitle');
      const trainingDesc = document.getElementById('trainingTaskDesc');
      
      const todayWorkout = await getWorkoutByDate(todayKey());
      if (todayWorkout && todayWorkout.exercises && todayWorkout.exercises.length > 0) {
        const calories = Math.round(calculateWorkoutCalories(todayWorkout.exercises));
        const exerciseCount = todayWorkout.exercises.length;
        trainingTask.classList.remove('border-2', 'border-dark-border');
        trainingTask.classList.add('border', 'border-indigo-500/50', 'bg-indigo-600/10');
        trainingTitle.innerHTML = '‚úì Workout completed';
        trainingDesc.textContent = `${exerciseCount} exercise${exerciseCount !== 1 ? 's' : ''} ‚Ä¢ ${calories} cal burned`;
      }

      // Update summary card
      await updateSummaryCard();
    }

    // Update Today's Summary Card
    async function updateSummaryCard() {
      const nutritionData = getTodayData('nutrition');
      const sleepData = getTodayData('sleep');
      const todayWorkout = await getWorkoutByDate(todayKey());
      
      // Calories
      let totalCals = 0;
      if (nutritionData && nutritionData.meals) {
        Object.values(nutritionData.meals).forEach(meal => {
          if (Array.isArray(meal)) {
            totalCals += meal.reduce((s, dish) => s + (dish.calories || 0), 0);
          } else {
            totalCals += meal.calories || 0;
          }
        });
      }
      document.getElementById('summaryCalories').textContent = Math.round(totalCals).toLocaleString();
      
      // Workouts
      const workoutCount = todayWorkout && todayWorkout.exercises ? todayWorkout.exercises.length : 0;
      document.getElementById('summaryWorkouts').textContent = workoutCount;
      
      // Sleep
      if (sleepData && sleepData.durationMins) {
        const hours = (sleepData.durationMins / 60).toFixed(1);
        document.getElementById('summarySleep').textContent = hours + 'h';
      } else {
        document.getElementById('summarySleep').textContent = '--';
      }
    }

    // Date range state
    let dateRangeStart = null;
    let dateRangeEnd = null;

    // Initialize date range to last 7 days
    function initializeDateRange() {
      const today = new Date();
      const sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
      
      dateRangeEnd = formatDateForInput(today);
      dateRangeStart = formatDateForInput(sevenDaysAgo);
      
      document.getElementById('dateRangeStart').value = dateRangeStart;
      document.getElementById('dateRangeEnd').value = dateRangeEnd;
    }

    function formatDateForInput(date) {
      return date.toISOString().split('T')[0];
    }

    // Get array of dates between start and end
    function getDateRange() {
      const start = new Date(dateRangeStart);
      const end = new Date(dateRangeEnd);
      const dates = [];
      
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        dates.push(new Date(d));
      }
      
      return dates;
    }

    // Convert date to key format (YYYY-MM-DD)
    function dateToKey(date) {
      return date.toISOString().split('T')[0];
    }

    // Get short label for date
    function getDateLabel(date) {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${days[date.getDay()]} ${months[date.getMonth()]} ${date.getDate()}`;
    }

    // Generic line chart renderer
    function renderLineChart(container, dataPoints, color, unit = '') {
      if (dataPoints.length === 0) {
        container.innerHTML = '<div class="flex items-center justify-center h-full text-xs text-dark-muted">No data</div>';
        return;
      }

      const values = dataPoints.map(d => d.value);
      const maxValue = Math.max(...values, 1);
      const minValue = Math.min(...values, 0);
      const range = maxValue - minValue || 1;

      // Calculate SVG path points
      const width = 100; // percentage
      const height = 100; // percentage
      const points = dataPoints.map((d, i) => {
        const x = (i / (dataPoints.length - 1 || 1)) * width;
        const y = height - ((d.value - minValue) / range) * height;
        return `${x},${y}`;
      }).join(' ');

      container.innerHTML = `
        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
          <!-- Grid lines -->
          <line x1="0" y1="25" x2="100" y2="25" stroke="#2d3d54" stroke-width="0.5" />
          <line x1="0" y1="50" x2="100" y2="50" stroke="#2d3d54" stroke-width="0.5" />
          <line x1="0" y1="75" x2="100" y2="75" stroke="#2d3d54" stroke-width="0.5" />
          
          <!-- Line path -->
          <polyline
            points="${points}"
            fill="none"
            stroke="${color}"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          
          <!-- Data points -->
          ${dataPoints.map((d, i) => {
            const x = (i / (dataPoints.length - 1 || 1)) * 100;
            const y = 100 - ((d.value - minValue) / range) * 100;
            return `<circle cx="${x}" cy="${y}" r="2.5" fill="${color}" class="hover-point">
              <title>${d.label}: ${d.value}${unit}</title>
            </circle>`;
          }).join('')}
        </svg>
      `;
    }

    // Dashboard rendering
    async function renderDashboard() {
      await renderSleepTrend();
      await renderNutritionTrend();
      await renderActivityTrend();
      await renderTrainingTrend();
    }

    async function renderSleepTrend() {
      const data = await getData('sleep');
      const chartEl = document.getElementById('dashSleepChart');
      const avgEl = document.getElementById('dashSleepAvg');

      const dates = getDateRange();
      const dataPoints = [];
      const validData = [];

      dates.forEach(date => {
        const key = dateToKey(date);
        const day = data[key];
        
        if (day && day.durationMins) {
          const hours = day.durationMins / 60;
          dataPoints.push({
            label: getDateLabel(date),
            value: hours
          });
          validData.push(hours);
        }
      });

      if (validData.length > 0) {
        renderLineChart(chartEl, dataPoints, '#818cf8', 'h');
        const avgHours = (validData.reduce((s, v) => s + v, 0) / validData.length).toFixed(1);
        avgEl.textContent = `${avgHours}h avg (${validData.length} days)`;
      } else {
        chartEl.innerHTML = '<div class="flex items-center justify-center h-full text-xs text-dark-muted">No sleep data</div>';
        avgEl.textContent = 'No data';
      }
    }

    async function renderNutritionTrend() {
      const data = await getData('nutrition');
      const chartEl = document.getElementById('dashNutritionChart');
      const avgEl = document.getElementById('dashNutritionAvg');

      const dates = getDateRange();
      const dataPoints = [];
      const validData = [];

      dates.forEach(date => {
        const key = dateToKey(date);
        const day = data[key];
        
        let totalCals = 0;
        if (day && day.meals) {
          Object.values(day.meals).forEach(meal => {
            if (Array.isArray(meal)) {
              totalCals += meal.reduce((s, dish) => s + (dish.calories || 0), 0);
            } else {
              totalCals += meal.calories || 0;
            }
          });
        }
        
        if (totalCals > 0) {
          dataPoints.push({
            label: getDateLabel(date),
            value: totalCals
          });
          validData.push(totalCals);
        }
      });

      if (validData.length > 0) {
        renderLineChart(chartEl, dataPoints, '#a5b4fc', ' cal');
        const avgCals = Math.round(validData.reduce((s, v) => s + v, 0) / validData.length);
        avgEl.textContent = `${avgCals} cal/day avg (${validData.length} days)`;
      } else {
        chartEl.innerHTML = '<div class="flex items-center justify-center h-full text-xs text-dark-muted">No nutrition data</div>';
        avgEl.textContent = 'No data';
      }
    }

    async function renderActivityTrend() {
      const data = await getData('activity');
      const chartEl = document.getElementById('dashActivityChart');
      const avgEl = document.getElementById('dashActivityAvg');

      const dates = getDateRange();
      const dataPoints = [];
      const validData = [];

      dates.forEach(date => {
        const key = dateToKey(date);
        const day = data[key];
        const steps = day && day.steps ? day.steps : 0;
        const gymMins = day && day.gymSessions ? day.gymSessions.reduce((s, g) => s + (g.minutes || 0), 0) : 0;
        const totalActivity = steps + (gymMins * 100); // Weight gym minutes more
        
        if (totalActivity > 0) {
          dataPoints.push({
            label: getDateLabel(date),
            value: totalActivity
          });
          validData.push(totalActivity);
        }
      });

      if (validData.length > 0) {
        renderLineChart(chartEl, dataPoints, '#6366f1', '');
        const avgActivity = Math.round(validData.reduce((s, v) => s + v, 0) / validData.length);
        avgEl.textContent = `Activity score ${avgActivity} avg (${validData.length} days)`;
      } else {
        chartEl.innerHTML = '<div class="flex items-center justify-center h-full text-xs text-dark-muted">No activity data</div>';
        avgEl.textContent = 'No data';
      }
    }

    async function renderTrainingTrend() {
      const workouts = await getWorkouts();
      const chartEl = document.getElementById('dashTrainingChart');
      const avgEl = document.getElementById('dashTrainingAvg');

      // Group workouts by date
      const workoutsByDate = {};
      workouts.forEach(w => {
        workoutsByDate[w.date] = w;
      });

      const dates = getDateRange();
      const dataPoints = [];
      const validData = [];

      dates.forEach(date => {
        const key = dateToKey(date);
        const workout = workoutsByDate[key];
        
        if (workout && workout.exercises) {
          const calories = Math.round(calculateWorkoutCalories(workout.exercises));
          if (calories > 0) {
            dataPoints.push({
              label: getDateLabel(date),
              value: calories
            });
            validData.push(calories);
          }
        }
      });

      if (validData.length > 0) {
        renderLineChart(chartEl, dataPoints, '#818cf8', ' cal');
        const avgCals = Math.round(validData.reduce((s, v) => s + v, 0) / validData.length);
        avgEl.textContent = `${avgCals} cal/day avg (${validData.length} days)`;
      } else {
        chartEl.innerHTML = '<div class="flex items-center justify-center h-full text-xs text-dark-muted">No training data</div>';
        avgEl.textContent = 'No data';
      }
    }

    // Update daily goal progress
    async function updateDailyGoalProgress() {
      const profile = await getUserProfile();
      const nutritionData = getTodayData('nutrition');
      
      if (!profile || !profile.weight || !profile.height || !profile.date_of_birth || !profile.sex) {
        document.getElementById('dailyGoalSection').style.display = 'none';
        return;
      }
      
      document.getElementById('dailyGoalSection').style.display = 'block';
      
      // Calculate target calories from profile
      const age = calculateAge(profile.date_of_birth);
      const bmr = calculateBMR(profile.weight, profile.height, age, profile.sex);
      const tdee = calculateTDEE(bmr, profile.activity_level || 1.2);
      const goalSpeed = profile.goal_speed || 'moderate';
      
      // Use profile-logic functions
      const strategy = calculateCalorieStrategyBySpeed(tdee, goalSpeed);
      const targetCalories = Math.round(strategy.targetCalories);
      
      // Calculate consumed calories
      let consumedCalories = 0;
      if (nutritionData && nutritionData.meals) {
        Object.values(nutritionData.meals).forEach(meal => {
          if (Array.isArray(meal)) {
            consumedCalories += meal.reduce((s, dish) => s + (dish.calories || 0), 0);
          } else {
            consumedCalories += meal.calories || 0;
          }
        });
      }
      
      // Calculate percentage
      const percentage = targetCalories > 0 ? Math.min(Math.round((consumedCalories / targetCalories) * 100), 100) : 0;
      const remaining = targetCalories - consumedCalories;
      
      // Update UI
      document.getElementById('goalPercentage').textContent = percentage + '%';
      document.getElementById('caloriesConsumed').textContent = Math.round(consumedCalories) + ' cal';
      document.getElementById('caloriesGoal').textContent = targetCalories + ' cal';
      document.getElementById('caloriesRemaining').textContent = remaining > 0 ? remaining + ' cal' : '0 cal';
      document.getElementById('goalStrategyText').textContent = strategy.strategyName + ' ‚Ä¢ ' + strategy.deficitInfo;
      
      // Update progress circle
      const circle = document.getElementById('progressCircle');
      const circumference = 2 * Math.PI * 52; // 2œÄr where r=52
      const offset = circumference - (percentage / 100) * circumference;
      circle.style.strokeDashoffset = offset;
      
      // Change color based on progress
      if (percentage >= 100) {
        circle.style.stroke = '#6366f1'; // indigo - goal met
      } else if (percentage >= 80) {
        circle.style.stroke = '#818cf8'; // lighter indigo - close to goal
      } else {
        circle.style.stroke = '#a5b4fc'; // light indigo - needs work
      }
    }

    // Helper functions from profile-logic.js (needed here)
    function calculateAge(dateOfBirth) {
      const today = new Date();
      const birthDate = new Date(dateOfBirth);
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }

    function calculateBMR(weight, height, age, sex) {
      const baseBMR = (10 * weight) + (6.25 * height) - (5 * age);
      return sex === 'male' ? baseBMR + 5 : baseBMR - 161;
    }

    function calculateTDEE(bmr, activityLevel) {
      return bmr * activityLevel;
    }

    function calculateCalorieStrategyBySpeed(tdee, goalSpeed) {
      const strategies = {
        'extreme': { deficit: -1000, weeklyWeightChange: -1.0, strategyName: 'Extreme Weight Loss', deficitInfo: '1 kg/week loss' },
        'fast': { deficit: -750, weeklyWeightChange: -0.75, strategyName: 'Fast Weight Loss', deficitInfo: '0.75 kg/week loss' },
        'moderate': { deficit: -500, weeklyWeightChange: -0.5, strategyName: 'Moderate Weight Loss', deficitInfo: '0.5 kg/week loss' },
        'slow': { deficit: -250, weeklyWeightChange: -0.25, strategyName: 'Slow Weight Loss', deficitInfo: '0.25 kg/week loss' },
        'maintain': { deficit: 0, weeklyWeightChange: 0, strategyName: 'Weight Maintenance', deficitInfo: 'Maintain current weight' },
        'gain-slow': { deficit: 250, weeklyWeightChange: 0.25, strategyName: 'Slow Weight Gain', deficitInfo: '0.25 kg/week gain' },
        'gain-fast': { deficit: 500, weeklyWeightChange: 0.5, strategyName: 'Fast Weight Gain', deficitInfo: '0.5 kg/week gain' }
      };
      const strategy = strategies[goalSpeed] || strategies['moderate'];
      return {
        targetCalories: tdee + strategy.deficit,
        strategyName: strategy.strategyName,
        deficitInfo: strategy.deficitInfo,
        weeklyWeightChange: strategy.weeklyWeightChange,
        deficit: strategy.deficit
      };
    }

    // Date range controls
    document.getElementById('applyDateRange').addEventListener('click', async () => {
      dateRangeStart = document.getElementById('dateRangeStart').value;
      dateRangeEnd = document.getElementById('dateRangeEnd').value;
      
      if (!dateRangeStart || !dateRangeEnd) {
        alert('Please select both start and end dates');
        return;
      }
      
      if (new Date(dateRangeStart) > new Date(dateRangeEnd)) {
        alert('Start date must be before end date');
        return;
      }
      
      await renderDashboard();
    });

    document.getElementById('reset7Days').addEventListener('click', async () => {
      initializeDateRange();
      await renderDashboard();
    });

    // Initialize - will run after auth check
    async function initDashboard() {
      initializeDateRange();
      await updateTodayTasks();
      await updateDailyGoalProgress();
      await renderDashboard();
    }

    // Auth check and init
    (async () => {
      const user = await requireAuth();
      if (user) {
        document.getElementById('userEmail').textContent = user.email;
        // Auto-seed sample data for new users
        await checkAndSeedNewUser();
        await initDashboard();
      }
    })();

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>

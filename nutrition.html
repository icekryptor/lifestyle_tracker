<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nutrition Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Outfit', 'sans-serif']
          },
          colors: {
            cream: {
              50: '#faf8f5',
              100: '#f5f2ed'
            },
            sage: '#7d8b6f',
            lavender: '#8b7d9e',
            terracotta: '#9e8b7d',
            teal: '#7d9e8b',
            stone: {
              border: '#e8e4de',
              text: '#2d2a26',
              muted: '#6b6560'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-cream-50 text-stone-text min-h-screen font-sans">
  <div class="max-w-md mx-auto p-6 pb-12">
    <!-- Header with back button -->
    <header class="mb-8 pb-4 border-b border-stone-border flex items-center gap-4">
      <a href="index.html" class="w-8 h-8 rounded-full hover:bg-stone-border/50 flex items-center justify-center transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </a>
      <div>
        <h1 class="text-2xl font-medium tracking-tight">Nutrition Tracker</h1>
        <p class="text-sm text-stone-muted font-light mt-1" id="todayDate"></p>
      </div>
    </header>

    <!-- Daily Summary -->
    <section class="bg-white rounded-xl border border-stone-border p-5 mb-4">
      <h2 class="text-xs font-medium uppercase tracking-wider text-terracotta mb-4">Daily Summary</h2>
      <div class="grid grid-cols-2 gap-3">
        <div class="bg-cream-50 rounded-lg p-3">
          <div class="text-2xl font-semibold" id="totalCalories">0</div>
          <div class="text-xs text-stone-muted">Calories</div>
        </div>
        <div class="bg-cream-50 rounded-lg p-3">
          <div class="text-2xl font-semibold" id="mealsLogged">0/4</div>
          <div class="text-xs text-stone-muted">Meals</div>
        </div>
      </div>
      <div class="grid grid-cols-4 gap-2 mt-3">
        <div class="text-center">
          <div class="text-lg font-medium" id="totalProtein">0g</div>
          <div class="text-xs text-stone-muted">Protein</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-medium" id="totalCarbs">0g</div>
          <div class="text-xs text-stone-muted">Carbs</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-medium" id="totalFats">0g</div>
          <div class="text-xs text-stone-muted">Fats</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-medium" id="totalFiber">0g</div>
          <div class="text-xs text-stone-muted">Fiber</div>
        </div>
      </div>
    </section>

    <!-- Food Library Preview -->
    <section class="bg-white rounded-xl border border-stone-border p-5 mb-4">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xs font-medium uppercase tracking-wider text-terracotta">Food Library</h2>
        <a href="food-library.html" class="text-xs px-3 py-1.5 rounded-lg bg-terracotta text-white font-medium hover:opacity-90 transition-opacity">
          View All ‚Üí
        </a>
      </div>
      <div id="dishesPreview" class="space-y-2"></div>
    </section>

    <!-- Breakfast -->
    <section class="bg-white rounded-xl border border-stone-border p-5 mb-4">
      <div class="flex justify-between items-start mb-3">
        <div>
          <h2 class="text-sm font-medium">üåÖ Breakfast</h2>
          <p class="text-xs text-stone-muted">Carbs, healthy fats & fiber</p>
        </div>
        <button class="text-xs px-2 py-1 rounded bg-terracotta/10 text-terracotta font-medium" onclick="openMealModal('breakfast')">+ Add</button>
      </div>
      <div id="breakfastContent" class="empty-meal text-sm text-stone-muted">No meal logged</div>
    </section>

    <!-- Lunch -->
    <section class="bg-white rounded-xl border border-stone-border p-5 mb-4">
      <div class="flex justify-between items-start mb-3">
        <div>
          <h2 class="text-sm font-medium">‚òÄÔ∏è Lunch</h2>
          <p class="text-xs text-stone-muted">30% protein, 70% carbs, 1 fruit</p>
        </div>
        <button class="text-xs px-2 py-1 rounded bg-terracotta/10 text-terracotta font-medium" onclick="openMealModal('lunch')">+ Add</button>
      </div>
      <div id="lunchContent" class="empty-meal text-sm text-stone-muted">No meal logged</div>
    </section>

    <!-- Dinner -->
    <section class="bg-white rounded-xl border border-stone-border p-5 mb-4">
      <div class="flex justify-between items-start mb-3">
        <div>
          <h2 class="text-sm font-medium">üåÜ Dinner</h2>
          <p class="text-xs text-stone-muted">50% protein, 50% carbs + treat</p>
        </div>
        <button class="text-xs px-2 py-1 rounded bg-terracotta/10 text-terracotta font-medium" onclick="openMealModal('dinner')">+ Add</button>
      </div>
      <div id="dinnerContent" class="empty-meal text-sm text-stone-muted">No meal logged</div>
    </section>

    <!-- Supper -->
    <section class="bg-white rounded-xl border border-stone-border p-5 mb-4">
      <div class="flex justify-between items-start mb-3">
        <div>
          <h2 class="text-sm font-medium">üåô Supper</h2>
          <p class="text-xs text-stone-muted">100% protein</p>
        </div>
        <button class="text-xs px-2 py-1 rounded bg-terracotta/10 text-terracotta font-medium" onclick="openMealModal('supper')">+ Add</button>
      </div>
      <div id="supperContent" class="empty-meal text-sm text-stone-muted">No meal logged</div>
    </section>

    <!-- Nutrition History Calendar -->
    <section class="bg-white rounded-xl border border-stone-border p-5 mb-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xs font-medium uppercase tracking-wider text-terracotta">Nutrition History</h2>
        <div class="flex gap-2">
          <button id="prevMonth" class="w-8 h-8 rounded-lg hover:bg-cream-50 flex items-center justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <button id="nextMonth" class="w-8 h-8 rounded-lg hover:bg-cream-50 flex items-center justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="text-center text-sm font-medium mb-3" id="calendarMonth"></div>
      <div class="grid grid-cols-7 gap-1 mb-2">
        <div class="text-center text-xs font-medium text-stone-muted py-2">S</div>
        <div class="text-center text-xs font-medium text-stone-muted py-2">M</div>
        <div class="text-center text-xs font-medium text-stone-muted py-2">T</div>
        <div class="text-center text-xs font-medium text-stone-muted py-2">W</div>
        <div class="text-center text-xs font-medium text-stone-muted py-2">T</div>
        <div class="text-center text-xs font-medium text-stone-muted py-2">F</div>
        <div class="text-center text-xs font-medium text-stone-muted py-2">S</div>
      </div>
      <div class="grid grid-cols-7 gap-1" id="calendarDays"></div>
    </section>
  </div>

  <!-- Meal Input Modal -->
  <div id="mealModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl max-w-sm w-full p-5 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-medium" id="modalTitle">Add Meal</h3>
        <button id="closeModal" class="w-8 h-8 rounded-lg hover:bg-cream-50 flex items-center justify-center">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex gap-2 mb-4 border-b border-stone-border">
        <button id="quickAddTab" class="flex-1 py-2 text-sm font-medium border-b-2 border-terracotta text-terracotta transition-colors">
          Quick Add
        </button>
        <button id="manualEntryTab" class="flex-1 py-2 text-sm font-medium border-b-2 border-transparent text-stone-muted hover:text-stone-text transition-colors">
          Manual Entry
        </button>
      </div>

      <!-- Quick Add Content -->
      <div id="quickAddContent">
        <div class="space-y-3">
          <div class="relative">
            <label class="text-xs font-medium text-stone-muted block mb-2">SEARCH DISH</label>
            <input 
              type="text" 
              id="dishAutocomplete" 
              placeholder="Start typing dish name..." 
              autocomplete="off"
              class="w-full border border-stone-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-terracotta"
            />
            <div id="autocompleteResults" class="hidden absolute z-10 w-full mt-1 bg-white border border-stone-border rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
          </div>
          
          <div id="selectedDishInfo" class="hidden bg-cream-50 rounded-lg p-3 border border-stone-border">
            <div class="flex gap-3">
              <img id="selectedDishPhoto" class="w-16 h-16 rounded-lg object-cover hidden" />
              <div class="flex-1">
                <div class="font-medium text-sm" id="selectedDishName"></div>
                <div class="text-xs text-stone-muted/60" id="selectedDishBrand"></div>
                <div class="text-xs text-stone-muted" id="selectedDishMacros"></div>
              </div>
            </div>
          </div>
          
          <div id="portionSection" class="hidden">
            <label class="text-xs font-medium text-stone-muted block mb-1">PORTION SIZE (g)</label>
            <input type="number" id="portionSize" min="1" placeholder="100" value="100" class="w-full border border-stone-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-terracotta mb-3" />
            <button id="addDishToMeal" class="w-full bg-terracotta text-white rounded-lg px-4 py-2.5 text-sm font-medium hover:opacity-90 transition-opacity">
              Add to Meal
            </button>
          </div>

          <div class="mt-4 p-3 bg-cream-50 rounded-lg border border-stone-border/50">
            <p class="text-xs text-stone-muted">
              üí° <strong>Tip:</strong> Type to search your dishes. Macros will be calculated automatically based on portion size!
            </p>
          </div>
        </div>
      </div>

      <!-- Manual Entry Content -->
      <div id="manualEntryContent" class="hidden">
        <!-- Photo Upload -->
        <div class="mb-4">
          <label class="text-xs font-medium text-stone-muted block mb-2">MEAL PHOTO (OPTIONAL)</label>
          <div class="border-2 border-dashed border-stone-border rounded-lg p-4 text-center cursor-pointer hover:border-terracotta transition-colors" id="photoUpload">
            <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden" />
            <svg class="w-8 h-8 mx-auto text-stone-muted mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <p class="text-xs text-stone-muted">Tap to take photo or upload</p>
            <img id="photoPreview" class="hidden mt-2 rounded-lg w-full" />
          </div>
          <button id="aiRecognize" class="w-full mt-2 text-xs py-2 bg-terracotta/10 text-terracotta rounded-lg font-medium hover:bg-terracotta/20 transition-colors hidden">
            ü§ñ AI Recognize Nutrition
          </button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="text-xs font-medium text-stone-muted block mb-1">DESCRIPTION</label>
            <input type="text" id="mealDescription" placeholder="What did you eat?" class="w-full border border-stone-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-terracotta" />
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs font-medium text-stone-muted block mb-1">PROTEIN (g)</label>
              <input type="number" id="mealProtein" min="0" placeholder="0" class="w-full border border-stone-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-terracotta" />
            </div>
            <div>
              <label class="text-xs font-medium text-stone-muted block mb-1">CARBS (g)</label>
              <input type="number" id="mealCarbs" min="0" placeholder="0" class="w-full border border-stone-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-terracotta" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs font-medium text-stone-muted block mb-1">FATS (g)</label>
              <input type="number" id="mealFats" min="0" placeholder="0" class="w-full border border-stone-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-terracotta" />
            </div>
            <div>
              <label class="text-xs font-medium text-stone-muted block mb-1">FIBER (g)</label>
              <input type="number" id="mealFiber" min="0" placeholder="0" class="w-full border border-stone-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-terracotta" />
            </div>
          </div>

          <div>
            <label class="text-xs font-medium text-stone-muted block mb-1">CALORIES</label>
            <input type="number" id="mealCalories" min="0" placeholder="Auto-calculated" class="w-full border border-stone-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-terracotta" />
            <p class="text-xs text-stone-muted mt-1">Leave empty to auto-calculate (4 cal/g protein & carbs, 9 cal/g fat)</p>
          </div>

          <button id="saveMeal" class="w-full bg-sage text-white rounded-lg px-4 py-2.5 text-sm font-medium hover:opacity-90 transition-opacity mt-4">Save Meal</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load Supabase + DB first -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="db.js"></script>
  <script src="app.js"></script>
  <script src="nutrition-logic.js"></script>
  <script>
    // State
    let currentMealType = null;
    let currentCalendarDate = new Date();
    let uploadedPhoto = null;
    let editingMealDishIndex = null;

    // Update today's date
    document.getElementById('todayDate').textContent = formatDate(todayKey());

    // Photo upload handling
    document.getElementById('photoUpload').addEventListener('click', () => {
      document.getElementById('photoInput').click();
    });

    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedPhoto = e.target.result;
          document.getElementById('photoPreview').src = uploadedPhoto;
          document.getElementById('photoPreview').classList.remove('hidden');
          document.getElementById('aiRecognize').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // AI Recognition (placeholder for future API integration)
    document.getElementById('aiRecognize').addEventListener('click', () => {
      alert('ü§ñ AI Recognition coming soon!\n\nFor now, please enter nutrition facts manually.\n\nFuture: Integration with OpenAI Vision API or food recognition service.');
    });

    // Modal functions
    function openMealModal(mealType) {
      currentMealType = mealType;
      const titles = {
        breakfast: 'üåÖ Add Breakfast',
        lunch: '‚òÄÔ∏è Add Lunch',
        dinner: 'üåÜ Add Dinner',
        supper: 'üåô Add Supper'
      };
      const editTitles = {
        breakfast: 'üåÖ Edit Breakfast Dish',
        lunch: '‚òÄÔ∏è Edit Lunch Dish',
        dinner: 'üåÜ Edit Dinner Dish',
        supper: 'üåô Edit Supper Dish'
      };
      
      // Set title based on edit mode
      document.getElementById('modalTitle').textContent = editingMealDishIndex !== null ? 
        editTitles[mealType] : titles[mealType];
      
      // Only reset if not editing
      if (editingMealDishIndex === null) {
        // Always start with Quick Add tab
        switchToQuickAdd();
        
        // Clear form
        document.getElementById('mealDescription').value = '';
        document.getElementById('mealProtein').value = '';
        document.getElementById('mealCarbs').value = '';
        document.getElementById('mealFats').value = '';
        document.getElementById('mealFiber').value = '';
        document.getElementById('mealCalories').value = '';
        document.getElementById('photoPreview').classList.add('hidden');
        document.getElementById('aiRecognize').classList.add('hidden');
        uploadedPhoto = null;
      }
      
      document.getElementById('mealModal').classList.remove('hidden');
      document.getElementById('mealModal').classList.add('flex');
    }

    function closeMealModal() {
      document.getElementById('mealModal').classList.add('hidden');
      document.getElementById('mealModal').classList.remove('flex');
      currentMealType = null;
      uploadedPhoto = null;
      editingMealDishIndex = null;
    }

    document.getElementById('closeModal').addEventListener('click', closeMealModal);

    // Tab switching
    function switchToQuickAdd() {
      document.getElementById('quickAddTab').classList.add('border-terracotta', 'text-terracotta');
      document.getElementById('quickAddTab').classList.remove('border-transparent', 'text-stone-muted');
      document.getElementById('manualEntryTab').classList.remove('border-terracotta', 'text-terracotta');
      document.getElementById('manualEntryTab').classList.add('border-transparent', 'text-stone-muted');
      document.getElementById('quickAddContent').classList.remove('hidden');
      document.getElementById('manualEntryContent').classList.add('hidden');
    }

    function switchToManualEntry() {
      document.getElementById('manualEntryTab').classList.add('border-terracotta', 'text-terracotta');
      document.getElementById('manualEntryTab').classList.remove('border-transparent', 'text-stone-muted');
      document.getElementById('quickAddTab').classList.remove('border-terracotta', 'text-terracotta');
      document.getElementById('quickAddTab').classList.add('border-transparent', 'text-stone-muted');
      document.getElementById('manualEntryContent').classList.remove('hidden');
      document.getElementById('quickAddContent').classList.add('hidden');
    }

    document.getElementById('quickAddTab').addEventListener('click', switchToQuickAdd);
    document.getElementById('manualEntryTab').addEventListener('click', switchToManualEntry);

    document.getElementById('saveMeal').addEventListener('click', async () => {
      if (!currentMealType) return;

      const description = document.getElementById('mealDescription').value.trim();
      const protein = parseFloat(document.getElementById('mealProtein').value) || 0;
      const carbs = parseFloat(document.getElementById('mealCarbs').value) || 0;
      const fats = parseFloat(document.getElementById('mealFats').value) || 0;
      const fiber = parseFloat(document.getElementById('mealFiber').value) || 0;
      let calories = parseFloat(document.getElementById('mealCalories').value);

      // Auto-calculate calories if not provided
      if (!calories || calories === 0) {
        calories = calculateCalories(protein, carbs, fats);
      }

      const dish = {
        description,
        protein,
        carbs,
        fats,
        fiber,
        calories,
        photo: uploadedPhoto,
        time: timeNow()
      };

      // Save to Supabase - meals are now arrays of dishes
      const data = await getData('nutrition');
      const today = data[todayKey()] || { meals: {} };
      
      // Initialize meal as array if it doesn't exist
      if (!today.meals[currentMealType]) {
        today.meals[currentMealType] = [];
      }
      
      // If it's an old single-object meal, convert to array
      if (!Array.isArray(today.meals[currentMealType])) {
        today.meals[currentMealType] = [today.meals[currentMealType]];
      }
      
      // Check if we're editing or adding
      if (editingMealDishIndex !== null) {
        // Update existing dish
        today.meals[currentMealType][editingMealDishIndex] = dish;
        editingMealDishIndex = null;
      } else {
        // Add new dish to meal array
        today.meals[currentMealType].push(dish);
      }
      
      await setNutritionData(todayKey(), today);

      closeMealModal();
      await loadNutrition();
      await renderCalendar();
    });

    // Load and display nutrition
    async function loadNutrition() {
      await getData('nutrition'); // Refresh cache from Supabase
      const today = getTodayData('nutrition') || { meals: {} };
      
      // Display each meal (meals are now arrays of dishes)
      ['breakfast', 'lunch', 'dinner', 'supper'].forEach(mealType => {
        const contentEl = document.getElementById(`${mealType}Content`);
        let meal = today.meals[mealType];
        
        // Convert old single-object meals to arrays for backward compatibility
        if (meal && !Array.isArray(meal)) {
          meal = [meal];
        }
        
        if (meal && meal.length > 0) {
          // Calculate meal totals
          const totalCals = meal.reduce((sum, dish) => sum + (dish.calories || 0), 0);
          const totalProtein = meal.reduce((sum, dish) => sum + (dish.protein || 0), 0);
          const totalCarbs = meal.reduce((sum, dish) => sum + (dish.carbs || 0), 0);
          const totalFats = meal.reduce((sum, dish) => sum + (dish.fats || 0), 0);
          const totalFiber = meal.reduce((sum, dish) => sum + (dish.fiber || 0), 0);
          
          contentEl.className = 'meal-content';
          contentEl.innerHTML = `
            <div class="space-y-2">
              ${meal.map((dish, index) => `
                <div class="flex gap-3 pb-2 ${index < meal.length - 1 ? 'border-b border-stone-border/30' : ''}">
                  ${dish.photo ? `<img src="${dish.photo}" class="w-12 h-12 rounded-lg object-cover" />` : ''}
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium">${dish.description || 'Dish'}</div>
                    <div class="text-xs text-stone-muted">
                      ${dish.calories} cal ‚Ä¢ P: ${dish.protein}g ‚Ä¢ C: ${dish.carbs}g ‚Ä¢ F: ${dish.fats}g
                    </div>
                  </div>
                  <div class="flex gap-1">
                    <button onclick="editMealDish('${mealType}', ${index})" class="text-stone-muted hover:text-terracotta" title="Edit">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                      </svg>
                    </button>
                    <button onclick="deleteDish('${mealType}', ${index})" class="text-stone-muted hover:text-red-500 text-lg" title="Delete">√ó</button>
                  </div>
                </div>
              `).join('')}
              
              <div class="bg-sage/5 rounded-lg p-2 mt-2">
                <div class="text-xs font-medium text-sage">MEAL TOTAL</div>
                <div class="text-sm font-semibold">üî• ${Math.round(totalCals)} cal</div>
                <div class="text-xs text-stone-muted">
                  P: ${Math.round(totalProtein)}g ‚Ä¢ C: ${Math.round(totalCarbs)}g ‚Ä¢ F: ${Math.round(totalFats)}g${totalFiber ? ' ‚Ä¢ Fiber: ' + Math.round(totalFiber) + 'g' : ''}
                </div>
              </div>
            </div>
          `;
        } else {
          contentEl.className = 'empty-meal text-sm text-stone-muted';
          contentEl.textContent = 'No meal logged';
        }
      });

      // Update daily summary
      updateDailySummary(today);
    }

    function updateDailySummary(dayData) {
      const meals = dayData.meals || {};
      const mealCount = Object.keys(meals).filter(key => {
        const meal = meals[key];
        return meal && (Array.isArray(meal) ? meal.length > 0 : true);
      }).length;
      
      let totalCals = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0, totalFiber = 0;
      
      Object.values(meals).forEach(meal => {
        // Handle both array (new) and object (old) formats
        if (Array.isArray(meal)) {
          meal.forEach(dish => {
            totalCals += dish.calories || 0;
            totalProtein += dish.protein || 0;
            totalCarbs += dish.carbs || 0;
            totalFats += dish.fats || 0;
            totalFiber += dish.fiber || 0;
          });
        } else {
          totalCals += meal.calories || 0;
          totalProtein += meal.protein || 0;
          totalCarbs += meal.carbs || 0;
          totalFats += meal.fats || 0;
          totalFiber += meal.fiber || 0;
        }
      });

      document.getElementById('totalCalories').textContent = Math.round(totalCals);
      document.getElementById('mealsLogged').textContent = `${mealCount}/4`;
      document.getElementById('totalProtein').textContent = Math.round(totalProtein) + 'g';
      document.getElementById('totalCarbs').textContent = Math.round(totalCarbs) + 'g';
      document.getElementById('totalFats').textContent = Math.round(totalFats) + 'g';
      document.getElementById('totalFiber').textContent = Math.round(totalFiber) + 'g';
    }

    async function deleteDish(mealType, dishIndex) {
      if (!confirm('Delete this dish?')) return;
      
      const data = await getData('nutrition');
      const today = data[todayKey()];
      if (today && today.meals && today.meals[mealType]) {
        let meal = today.meals[mealType];
        
        // Convert to array if needed
        if (!Array.isArray(meal)) {
          meal = [meal];
        }
        
        // Remove the dish
        meal.splice(dishIndex, 1);
        
        // Update or delete the meal
        if (meal.length === 0) {
          delete today.meals[mealType];
        } else {
          today.meals[mealType] = meal;
        }
        
        await setNutritionData(todayKey(), today);
        await loadNutrition();
        await renderCalendar();
      }
    }

    window.editMealDish = async function(mealType, dishIndex) {
      const data = await getData('nutrition');
      const today = data[todayKey()];
      if (!today || !today.meals || !today.meals[mealType]) return;
      
      let meal = today.meals[mealType];
      if (!Array.isArray(meal)) {
        meal = [meal];
      }
      
      const dish = meal[dishIndex];
      if (!dish) return;
      
      currentMealType = mealType;
      editingMealDishIndex = dishIndex;
      
      // Open modal first
      openMealModal(mealType);
      
      // Switch to manual entry tab
      switchToManualEntry();
      
      // Populate the manual entry fields with dish data
      document.getElementById('mealDescription').value = dish.description || '';
      document.getElementById('mealProtein').value = dish.protein || '';
      document.getElementById('mealCarbs').value = dish.carbs || '';
      document.getElementById('mealFats').value = dish.fats || '';
      document.getElementById('mealFiber').value = dish.fiber || '';
      document.getElementById('mealCalories').value = dish.calories || '';
      
      // Handle photo if present
      if (dish.photo) {
        uploadedPhoto = dish.photo;
        document.getElementById('photoPreview').src = dish.photo;
        document.getElementById('photoPreview').classList.remove('hidden');
      }
    };

    async function deleteMeal(mealType) {
      if (!confirm('Delete entire meal?')) return;
      
      const data = await getData('nutrition');
      const today = data[todayKey()];
      if (today && today.meals) {
        delete today.meals[mealType];
        await setNutritionData(todayKey(), today);
        await loadNutrition();
        await renderCalendar();
      }
    }

    // Calendar functions
    async function renderCalendar() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      document.getElementById('calendarMonth').textContent = 
        currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const nutritionData = await getData('nutrition');
      const daysEl = document.getElementById('calendarDays');
      daysEl.innerHTML = '';

      for (let i = 0; i < firstDay; i++) {
        daysEl.innerHTML += '<div></div>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = nutritionData[dateKey];
        const isToday = dateKey === todayKey();
        
        let dayClass = 'aspect-square flex flex-col items-center justify-center rounded-lg text-xs transition-colors ';
        let content = `<div class="font-medium">${day}</div>`;

        if (isToday) {
          dayClass += 'bg-terracotta/10 border-2 border-terracotta ';
        } else {
          dayClass += 'hover:bg-cream-50 ';
        }

        if (dayData && dayData.meals) {
          const mealCount = Object.keys(dayData.meals).length;
          const color = mealCount === 4 ? 'bg-green-400' : mealCount >= 2 ? 'bg-yellow-400' : 'bg-red-400';
          content += `<div class="w-1.5 h-1.5 ${color} rounded-full mt-0.5"></div>`;
        }

        daysEl.innerHTML += `<div class="${dayClass}">${content}</div>`;
      }
    }

    document.getElementById('prevMonth').addEventListener('click', async () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      await renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', async () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      await renderCalendar();
    });

    // ‚îÄ‚îÄ Dishes Management ‚îÄ‚îÄ
    
    // Cache for dishes (loaded from Supabase)
    let dishesCache = [];

    async function loadDishes() {
      dishesCache = await getDishes(); // From db.js
      const previewEl = document.getElementById('dishesPreview');
      
      if (dishesCache.length === 0) {
        previewEl.innerHTML = '<p class="text-sm text-stone-muted text-center py-4">No dishes yet. Add your first dish!</p>';
      } else {
        // Show only 3 most recent dishes
        const recentDishes = dishesCache.slice(0, 3);
        previewEl.innerHTML = recentDishes.map((dish) => `
          <div class="flex gap-3 p-2 hover:bg-cream-50 rounded-lg transition-colors">
            ${dish.photo ? `
              <img src="${dish.photo}" class="w-12 h-12 rounded-lg object-cover" />
            ` : `
              <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-cream-50 to-cream-100 flex items-center justify-center text-xl">
                ${getCategoryEmoji(dish.category)}
              </div>
            `}
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium truncate">${dish.name}</div>
              ${dish.brand ? `<div class="text-xs text-stone-muted/60">${dish.brand}</div>` : ''}
              <div class="text-xs text-stone-muted">
                ${dish.calories} cal ‚Ä¢ P: ${dish.protein}g ‚Ä¢ C: ${dish.carbs}g ‚Ä¢ F: ${dish.fats}g
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    function getCategoryEmoji(category) {
      const emojis = {
        meat: 'ü•©', fish: 'üêü', dairy: 'ü•õ', grains: 'üåæ',
        vegetables: 'ü•¨', fruits: 'üçé', pastry: 'ü•ê', 
        snacks: 'üçø', drinks: 'ü•§', other: 'üçΩÔ∏è'
      };
      return emojis[category] || 'üçΩÔ∏è';
    }

    // Quick add dish to meal
    // Autocomplete functionality
    let selectedDish = null;
    const autocompleteInput = document.getElementById('dishAutocomplete');
    const autocompleteResults = document.getElementById('autocompleteResults');

    autocompleteInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      
      if (query.length === 0) {
        autocompleteResults.classList.add('hidden');
        return;
      }

      const matches = dishesCache.filter(dish => 
        dish.name.toLowerCase().includes(query)
      ).slice(0, 5);

      if (matches.length === 0) {
        autocompleteResults.classList.add('hidden');
        return;
      }

      autocompleteResults.innerHTML = matches.map(dish => `
        <div class="p-3 hover:bg-cream-50 cursor-pointer border-b border-stone-border last:border-0 flex gap-2" onclick="selectDish('${dish.id}')">
          ${dish.photo ? `
            <img src="${dish.photo}" class="w-10 h-10 rounded object-cover" />
          ` : `
            <div class="w-10 h-10 rounded bg-gradient-to-br from-cream-50 to-cream-100 flex items-center justify-center text-lg">
              ${getCategoryEmoji(dish.category)}
            </div>
          `}
          <div class="flex-1">
            <div class="text-sm font-medium">${dish.name}</div>
            ${dish.brand ? `<div class="text-xs text-stone-muted/60">${dish.brand}</div>` : ''}
            <div class="text-xs text-stone-muted">${dish.calories} cal/100g</div>
          </div>
        </div>
      `).join('');
      autocompleteResults.classList.remove('hidden');
    });

    // Click outside to close autocomplete
    document.addEventListener('click', (e) => {
      if (!autocompleteInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
        autocompleteResults.classList.add('hidden');
      }
    });

    window.selectDish = function(dishId) {
      selectedDish = dishesCache.find(d => d.id === dishId);
      if (!selectedDish) return;

      autocompleteInput.value = selectedDish.name;
      autocompleteResults.classList.add('hidden');

      // Show selected dish info
      document.getElementById('selectedDishName').textContent = selectedDish.name;
      
      const brandEl = document.getElementById('selectedDishBrand');
      if (selectedDish.brand) {
        brandEl.textContent = selectedDish.brand;
        brandEl.classList.remove('hidden');
      } else {
        brandEl.classList.add('hidden');
      }
      
      document.getElementById('selectedDishMacros').textContent = 
        `Per 100g: ${selectedDish.calories} cal ‚Ä¢ P: ${selectedDish.protein}g ‚Ä¢ C: ${selectedDish.carbs}g ‚Ä¢ F: ${selectedDish.fats}g`;
      
      if (selectedDish.photo) {
        document.getElementById('selectedDishPhoto').src = selectedDish.photo;
        document.getElementById('selectedDishPhoto').classList.remove('hidden');
      } else {
        document.getElementById('selectedDishPhoto').classList.add('hidden');
      }

      document.getElementById('selectedDishInfo').classList.remove('hidden');
      document.getElementById('portionSection').classList.remove('hidden');
      document.getElementById('portionSize').value = '100';
    };

    document.getElementById('addDishToMeal').addEventListener('click', async () => {
      if (!selectedDish || !currentMealType) return;

      const portionSize = parseFloat(document.getElementById('portionSize').value) || 100;
      
      // Calculate nutrition for the portion
      const multiplier = portionSize / 100;
      const protein = Math.round(selectedDish.protein * multiplier * 10) / 10;
      const carbs = Math.round(selectedDish.carbs * multiplier * 10) / 10;
      const fats = Math.round(selectedDish.fats * multiplier * 10) / 10;
      const calories = Math.round(selectedDish.calories * multiplier);
      
      // Create dish object directly and save
      const dishItem = {
        description: `${selectedDish.name} (${portionSize}g)`,
        protein,
        carbs,
        fats,
        fiber: 0,
        calories,
        photo: selectedDish.photo,
        time: timeNow()
      };

      // Save to Supabase - meals are now arrays of dishes
      const data = await getData('nutrition');
      const today = data[todayKey()] || { meals: {} };
      
      // Initialize meal as array if it doesn't exist
      if (!today.meals[currentMealType]) {
        today.meals[currentMealType] = [];
      }
      
      // If it's an old single-object meal, convert to array
      if (!Array.isArray(today.meals[currentMealType])) {
        today.meals[currentMealType] = [today.meals[currentMealType]];
      }
      
      // Add dish to meal array
      today.meals[currentMealType].push(dishItem);
      
      await setNutritionData(todayKey(), today);

      // Reset quick add section
      selectedDish = null;
      autocompleteInput.value = '';
      document.getElementById('selectedDishInfo').classList.add('hidden');
      document.getElementById('portionSection').classList.add('hidden');
      
      // Close modal and refresh
      closeMealModal();
      await loadNutrition();
      await renderCalendar();
    });

    // Initialize - will run after auth check
    async function initNutrition() {
      await loadDishes();
      await loadNutrition();
      await renderCalendar();
    }

    // Auth check and init
    (async () => {
      const user = await requireAuth();
      if (user) {
        await initNutrition();
      }
    })();
  </script>
</body>
</html>

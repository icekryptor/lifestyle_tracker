<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Regime - Activity</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'sans-serif']
          },
          colors: {
            navy: {
              50: '#e8edf5',
              100: '#c5d1e3'
            },
            slate: {
              700: '#2a3647',
              800: '#1e2a3a',
              850: '#1a2332',
              900: '#0f1729'
            },
            indigo: {
              400: '#a5b4fc',
              500: '#818cf8',
              600: '#6366f1',
              700: '#4f46e5'
            },
            
            
            
            dark: {
              border: '#2d3d54',
              text: '#e1e7f0',
              muted: '#8b95a8'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-slate-850 text-dark-text min-h-screen font-sans">
  <div class="max-w-[1000px] mx-auto p-4 lg:p-8 pb-12">
    <!-- Header with back button -->
    <header class="mb-8 pb-4 border-b border-dark-border flex items-center gap-4">
      <a href="index.html" class="w-8 h-8 rounded-full hover:bg-slate-700/50 flex items-center justify-center transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </a>
      <div>
        <h1 class="text-2xl font-medium tracking-tight">Activity Tracker</h1>
        <p class="text-sm text-dark-muted font-light mt-1" id="todayDate"></p>
      </div>
    </header>

    <!-- Daily Summary -->
    <section class="bg-slate-800 rounded-xl border border-dark-border p-5 mb-4">
      <h2 class="text-xs font-medium uppercase tracking-wider text-indigo-400 mb-4">Today's Activity</h2>
      <div class="bg-slate-850 rounded-lg p-4">
        <div class="text-center">
          <div class="text-3xl font-semibold tracking-tight" id="totalCalories">0</div>
          <div class="text-xs text-dark-muted mt-1">CALORIES BURNED</div>
        </div>
        <div class="grid grid-cols-2 gap-3 mt-4 pt-4 border-t border-dark-border">
          <div class="text-center">
            <div class="text-lg font-medium" id="totalSteps">0</div>
            <div class="text-xs text-dark-muted">STEPS</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-medium" id="totalWorkoutCals">0</div>
            <div class="text-xs text-dark-muted">WORKOUT</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Steps Section -->
    <section class="bg-slate-800 rounded-xl border border-dark-border p-5 mb-4">
      <h2 class="text-xs font-medium uppercase tracking-wider text-indigo-400 mb-4">Daily Steps</h2>
      
      <!-- Steps input -->
      <div id="stepsInput">
        <div class="flex gap-2 mb-3">
          <input type="number" id="stepsCount" min="0" placeholder="Enter steps" class="flex-1 border border-dark-border rounded-lg px-3 py-2.5 bg-slate-850 text-center text-lg font-medium focus:outline-none focus:border-teal" />
        </div>
        <button class="w-full bg-indigo-600 text-white rounded-lg px-4 py-2.5 font-medium hover:opacity-90 active:opacity-85 transition-opacity text-sm" id="logSteps">Log Steps</button>
      </div>

      <!-- Steps summary -->
      <div id="stepsSummary" class="hidden">
        <div class="bg-slate-850 rounded-lg p-4 mb-3">
          <div class="flex justify-between items-center mb-2">
            <span class="text-2xl font-semibold" id="stepsDisplay">0</span>
            <span class="text-sm text-dark-muted" id="stepsCalories">0 cal</span>
          </div>
          <div class="h-2 bg-stone-border rounded-full overflow-hidden mb-2">
            <div id="stepsProgress" class="h-full bg-indigo-600 transition-all duration-500" style="width: 0%"></div>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-xs text-dark-muted" id="stepsFeedback">Keep walking!</span>
            <span class="text-xs font-medium text-dark-muted" id="stepsPercentage">0%</span>
          </div>
        </div>
        <button class="w-full border border-dark-border rounded-lg px-4 py-2 text-sm text-dark-muted hover:border-teal hover:text-indigo-400 transition-colors" id="editSteps">Update steps</button>
      </div>
    </section>

    <!-- Today's Workout -->
    <section class="bg-slate-800 rounded-xl border border-dark-border p-5 mb-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xs font-medium uppercase tracking-wider text-indigo-400">Today's Workout</h2>
        <a href="training.html" class="text-xs text-indigo-400 hover:text-indigo-300 font-medium">
          Full Training Diary ‚Üí
        </a>
      </div>
      
      <div id="workoutSummary">
        <!-- Workout summary will be loaded here -->
      </div>
    </section>
  </div>

  <!-- Load Supabase + DB first -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="db.js"></script>
  <script src="app.js"></script>
  <script src="activity-logic.js"></script>
  <script src="training-logic.js"></script>
  <script>
    // Update today's date
    document.getElementById('todayDate').textContent = formatDate(todayKey());

    async function loadActivity() {
      const data = await getData('activity');
      const today = data[todayKey()] || { steps: 0, gymSessions: [] };
      
      // Load steps
      if (today.steps > 0) {
        showStepsSummary(today.steps);
      } else {
        showStepsInput();
      }
      
      // Load workout from training
      const trainingData = await getData('training');
      const todayWorkout = trainingData[todayKey()];
      loadWorkoutSummary(todayWorkout);
      
      // Update summary (including workout calories)
      updateSummary(today, todayWorkout);
    }

    function showStepsInput() {
      document.getElementById('stepsInput').classList.remove('hidden');
      document.getElementById('stepsSummary').classList.add('hidden');
    }

    function showStepsSummary(steps) {
      document.getElementById('stepsInput').classList.add('hidden');
      document.getElementById('stepsSummary').classList.remove('hidden');
      
      const analysis = analyzeSteps(steps);
      document.getElementById('stepsDisplay').textContent = steps.toLocaleString();
      document.getElementById('stepsCalories').textContent = `${analysis.calories} cal`;
      document.getElementById('stepsProgress').style.width = `${Math.min(analysis.percentage, 100)}%`;
      document.getElementById('stepsFeedback').textContent = analysis.feedback;
      document.getElementById('stepsPercentage').textContent = `${analysis.percentage}%`;
    }

    async function logSteps() {
      const steps = parseInt(document.getElementById('stepsCount').value, 10);
      if (isNaN(steps) || steps < 0) return;
      
      const data = await getData('activity');
      const today = data[todayKey()] || { steps: 0, gymSessions: [] };
      today.steps = steps;
      await setActivityData(todayKey(), today);
      
      document.getElementById('stepsCount').value = '';
      await loadActivity();
    }

    async function editSteps() {
      const data = await getData('activity');
      const today = data[todayKey()];
      if (today && today.steps) {
        document.getElementById('stepsCount').value = today.steps;
      }
      showStepsInput();
    }

    async function logGymSession() {
      const minutes = parseInt(document.getElementById('gymMinutes').value, 10);
      const intensity = document.getElementById('gymIntensity').value;
      
      if (isNaN(minutes) || minutes < 1) return;
      
      const calories = calculateGymCalories(minutes, intensity);
      const session = {
        minutes,
        intensity,
        calories,
        time: timeNow()
      };
      
      const data = await getData('activity');
      const today = data[todayKey()] || { steps: 0, gymSessions: [] };
      if (!today.gymSessions) today.gymSessions = [];
      today.gymSessions.push(session);
      await setActivityData(todayKey(), today);
      
      document.getElementById('gymMinutes').value = '';
      await loadActivity();
    }

    function loadGymSessions(sessions) {
      const listEl = document.getElementById('gymList');
      
      if (sessions.length === 0) {
        listEl.innerHTML = '<p class="text-sm text-dark-muted">No gym sessions logged today</p>';
        return;
      }
      
      listEl.innerHTML = sessions.map((s, i) => `
        <div class="flex justify-between items-center py-2 border-b border-dark-border last:border-b-0">
          <div class="flex-1">
            <div class="text-sm font-medium">${s.minutes} min ¬∑ ${s.intensity}</div>
            <div class="text-xs text-dark-muted">${s.calories} cal ¬∑ ${s.time}</div>
          </div>
          <button class="text-dark-muted hover:text-red-500 text-lg ml-2" data-i="${i}" aria-label="Remove">√ó</button>
        </div>
      `).join('');
      
      listEl.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => removeGymSession(parseInt(btn.dataset.i, 10)));
      });
    }

    async function removeGymSession(index) {
      const data = await getData('activity');
      const today = data[todayKey()];
      if (!today || !today.gymSessions || !today.gymSessions[index]) return;
      today.gymSessions.splice(index, 1);
      await setActivityData(todayKey(), today);
      await loadActivity();
    }

    function loadWorkoutSummary(workout) {
      const summaryEl = document.getElementById('workoutSummary');
      
      if (!workout || !workout.exercises || workout.exercises.length === 0) {
        summaryEl.innerHTML = `
          <div class="text-center py-6">
            <div class="text-3xl mb-2">üèãÔ∏è</div>
            <p class="text-sm text-dark-muted mb-3">No workout logged today</p>
            <a href="training.html" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
              Start Workout
            </a>
          </div>
        `;
        return;
      }
      
      const calories = Math.round(calculateWorkoutCalories(workout.exercises));
      const duration = workout.duration || '--';
      const exerciseCount = workout.exercises.length;
      
      summaryEl.innerHTML = `
        <div class="bg-slate-850 rounded-lg p-4">
          <div class="grid grid-cols-3 gap-3 mb-3">
            <div class="text-center">
              <div class="text-2xl font-semibold">${exerciseCount}</div>
              <div class="text-xs text-dark-muted">Exercises</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-semibold">${duration}</div>
              <div class="text-xs text-dark-muted">Duration</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-semibold text-indigo-400">${calories}</div>
              <div class="text-xs text-dark-muted">Calories</div>
            </div>
          </div>
          <div class="text-xs text-dark-muted text-center border-t border-dark-border pt-3">
            ${workout.exercises.map(ex => ex.name).slice(0, 3).join(', ')}${exerciseCount > 3 ? '...' : ''}
          </div>
        </div>
      `;
    }

    function updateSummary(today, workout) {
      const summary = calculateDailySummary(today);
      
      // Add workout calories to total
      let workoutCalories = 0;
      if (workout && workout.exercises && workout.exercises.length > 0) {
        workoutCalories = Math.round(calculateWorkoutCalories(workout.exercises));
      }
      
      const totalCalories = summary.totalCalories + workoutCalories;
      
      document.getElementById('totalCalories').textContent = totalCalories;
      document.getElementById('totalSteps').textContent = summary.steps.toLocaleString();
      document.getElementById('totalWorkoutCals').textContent = workoutCalories + ' cal';
    }

    // Initialize
    document.getElementById('logSteps').addEventListener('click', logSteps);
    document.getElementById('editSteps').addEventListener('click', editSteps);
    document.getElementById('logGym').addEventListener('click', logGymSession);
    
    // Allow Enter key for steps
    document.getElementById('stepsCount').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') logSteps();
    });
    
    // Initialize - will run after auth check
    async function initActivity() {
      await loadActivity();
    }


    // Auth check and init
    (async () => {
      const user = await requireAuth();
      if (user) {
        await initActivity();
      }
    })();
  </script>
</body>
</html>
